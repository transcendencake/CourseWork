@model CourseWork.Models.Chapter

<link rel="stylesheet" href="~/css/site.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<body>
    <input type="hidden" id="customInput" value="@ViewBag.BookId" />
    @if (Model != null)
    {
        <form asp-action="Edit">
            <input type="hidden" id="chapterId" asp-for="Id" value="@Model.Id" />
            <textarea asp-for="Text" id="EditingArea">@Model.Text</textarea>
            <div class="btn-group">
                <button type="submit" class="btn btn-danger">Save</button>
                <a asp-action="DeleteChapter" asp-route-bookId="@ViewBag.BookId"
                   asp-route-chapterId="@Model.Id" class="btn btn-danger">Delete chapter</a>
            </div>
        </form>
    }
    else
    {
        <textarea disabled id="EditingArea">Choose or add chapter to edit</textarea>
    }
    <a asp-action="NewChapter" asp-route-bookId="@ViewBag.BookId" class="btn btn-danger">Add chapter</a>

    <ul class='list-group list-group-horizontal chaptersList' id="chaptersList">
        @for (int i = 1; i <= ViewBag.Chapters; i++)
        {
            <li class="list-group-item">
                <span class="my-handle">:: </span>
                <a asp-action="EditBook" asp-route-bookId="@ViewBag.BookId" asp-route-chapterNum="@i">@i</a>
            </li>
        }
    </ul>
</body>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/js/sortable.js"></script>
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
    var simplemde = new SimpleMDE({
        element: document.getElementById("EditingArea"),
        spellChecker: false,
        toolbar: [{
            name: "bold",
            action: SimpleMDE.toggleBold,
            className: "fa fa-bold btn-info",
            title: "Bold",
        }
        ],
    });

    var list = document.getElementById('chaptersList');
    Sortable.create(list, {
        handle: ".my-handle",
        animation: 150,
        onEnd: function (evt) {
            var data = {bookId: $('#customInput').val(), was: evt.oldIndex, become: evt.newIndex };
            $.ajax({
                type: "POST",
                url: '@Url.Action("ChangeChaptersOrder","Account")',
                contentType: 'application/x-www-form-urlencoded',
                data: data,
                success: function (result) {
                    SortChaptersList();
                    console.log(result);
                }
            })
        },
    });    

    function SortChaptersList() {
        var items = $('#chaptersList > li').get();
        console.log(items);
        items.sort(function (a, b) {
            var keyA = parseInt($(a.children[1]).text());
            var keyB = parseInt($(b.children[1]).text());

            if (keyA < keyB) return -1;
            if (keyA > keyB) return 1;
            return 0;
        });
        var list = $('#chaptersList');
        $.each(items, function (i, li) {
            list.append(li);
        });
    }
</script>
